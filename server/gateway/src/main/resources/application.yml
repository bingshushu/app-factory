server:
  port: 8080

spring:
  application:
    name: gateway

  # Redis 配置（用于限流）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 3000ms

  # Cloud Gateway 配置
  cloud:
    gateway:
      # 路由配置
      routes:
        # User Service - 认证相关（公开）
        - id: user-service-auth
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory

        # User Service - 用户管理（需认证，由 JwtAuthenticationFilter 处理）
        - id: user-service-users
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/users/**,/api/v1/profile/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

        # WebSocket Service
        - id: ws-service
          uri: ${WS_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/ws/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory

        # WebSocket 升级（ws://）
        - id: ws-service-websocket
          uri: ${WS_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/ws/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory

        # File Service
        - id: file-service
          uri: ${FILE_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/files/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
                key-resolver: "#{@ipKeyResolver}"

        # Notification Service
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - AddRequestHeader=X-Gateway, app-factory
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

      # 默认过滤器
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE

# JWT 配置
jwt:
  secret: ${JWT_SECRET:your-secret-key-change-this-in-production-min-256-bits-long}

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      enabled: true

# 日志配置
logging:
  level:
    root: INFO
    com.appfactory.gateway: DEBUG
    org.springframework.cloud.gateway: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
